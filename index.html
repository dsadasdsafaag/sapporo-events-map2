<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆLeaflet Routing Machine + OSRMï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      display: flex; flex-direction: column;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #fff;
    }
    header {
      min-height: 56px; padding: 8px 12px;
      border-bottom: 1px solid #eee;
      display: grid; gap: 8px;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
    }
    h1 { margin: 0; font-size: 16px; line-height: 1.2; }
    #controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    select, input[type="search"], button {
      padding: 8px 10px; font-size: 13px; border-radius: 8px; border: 1px solid #ddd; background: #fff;
    }
    button.primary { background: #2fbf71; color: #fff; border-color: #2fbf71; }
    button.ghost { background: #fff; color: #333; border-color: #ccc; }
    button:active { transform: translateY(1px); }
    #map { flex: 1; width: 100%; }

    /* å³ä¸‹ã®å‡¡ä¾‹ï¼ˆè¦ªæŒ‡ã§éš ã‚Œã«ãã„ï¼‰ */
    .legend {
      position: absolute; z-index: 1000; right: 10px; bottom: 10px;
      background: rgba(255,255,255,.95);
      border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.06);
    }
    .legend-item { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
    .dot { width: 11px; height: 11px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,.2); }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¦‹ãŸç›® */
    .popup-title{ font-weight:700; margin:0 0 4px; font-size:14px; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; background:#eef; }
    .popup-desc{ margin-top:6px; font-size:13px; line-height:1.5; color:#333; }
    .popup-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap: wrap; }
    .btn { padding:6px 10px; font-size:13px; border-radius:8px; border:1px solid #ddd; background:#fff; }
    .btn.run { background:#3a86ff; color:#fff; border-color:#3a86ff; }
    .btn.link { background:#fff; color:#333; border-color:#bbb; }

    /* åºƒå‘Šæ ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ */
    .adbar {
      width: 100%; min-height: 60px; border-top: 1px solid #eee;
      display:flex; align-items:center; justify-content:center; color:#777; font-size:12px;
      background: #fafafa;
    }

    /* ã‚¹ãƒãƒ›ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã‚’2æ®µã«æŠ˜ã‚ŠãŸãŸã‚€ */
    @media (max-width: 720px) {
      header { grid-template-columns: 1fr; }
      #controls { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <h1>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</h1>

    <div id="controls">
      <select id="when">
        <option value="all">ã™ã¹ã¦ã®æœŸé–“</option>
        <option value="today">ä»Šæ—¥</option>
        <option value="week">ä»Šé€±</option>
        <option value="month">ä»Šæœˆ</option>
      </select>

      <select id="cat">
        <option value="all">ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆã™ã¹ã¦ï¼‰</option>
        <option value="ã‚°ãƒ«ãƒ¡">ã‚°ãƒ«ãƒ¡</option>
        <option value="éŸ³æ¥½">éŸ³æ¥½</option>
        <option value="ã‚¢ãƒ¼ãƒˆ">ã‚¢ãƒ¼ãƒˆ</option>
        <option value="ã‚¹ãƒãƒ¼ãƒ„">ã‚¹ãƒãƒ¼ãƒ„</option>
        <option value="å­¦ã³">å­¦ã³</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>

      <input id="kw" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¼šå ´ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è§£èª¬ï¼‰" />

      <button id="locateBtn" class="primary">ç¾åœ¨åœ°ã‚’å–å¾—</button>
      <button id="clearRouteBtn" class="ghost">ãƒ«ãƒ¼ãƒˆã‚’æ¶ˆã™</button>
    </div>

    <!-- å…±æœ‰ç”¨ï¼ˆãƒãƒƒã‚·ãƒ¥ã«evt-idãŒå…¥ã‚‹ï¼‰ -->
    <button id="shareBtn" class="ghost">ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…±æœ‰</button>
  </header>

  <!-- ä¸Šéƒ¨åºƒå‘Šï¼ˆå¯©æŸ»å¾Œã«ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—æ›¿ãˆï¼‰ -->
  <div class="adbar" id="ad-top">åºƒå‘Šæ ï¼ˆAdSenseã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«æŒ¿å…¥ï¼‰</div>

  <div id="map"></div>

  <div class="legend" id="legend"></div>

  <!-- ä¸‹éƒ¨åºƒå‘Š -->
  <div class="adbar" id="ad-bottom">åºƒå‘Šæ ï¼ˆè¨˜äº‹ãƒšãƒ¼ã‚¸ã‚„ç‰¹é›†ã¨ä½µç”¨ãŒåŠ¹æœçš„ï¼‰</div>

  <script>
    // ========== åœ°å›³åˆæœŸåŒ– ==========
    if (!window.L) {
      document.getElementById('map').innerHTML = 'LeafletãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚æ‹¡å¼µæ©Ÿèƒ½ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
    } else {
      const map = L.map('map').setView([43.0618, 141.3545], 12);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // ========== é…è‰²ï¼ˆè‰²è¦šãƒãƒªã‚¢ãƒ•ãƒªãƒ¼å¯„ã‚Šï¼‰ ==========
      const CATEGORY_COLORS = {
        // ã‚ªãƒ¬ãƒ³ã‚¸ / ãƒ–ãƒ«ãƒ¼ / ãƒ‘ãƒ¼ãƒ—ãƒ« / ã‚°ãƒªãƒ¼ãƒ³ / ã‚¤ã‚¨ãƒ­ãƒ¼ / ã‚°ãƒ¬ãƒ¼
        "ã‚°ãƒ«ãƒ¡":   "#E4572E",
        "éŸ³æ¥½":    "#3A86FF",
        "ã‚¢ãƒ¼ãƒˆ":  "#8E5DFF",
        "ã‚¹ãƒãƒ¼ãƒ„": "#2FBF71",
        "å­¦ã³":    "#F2C14E",
        "ãã®ä»–":   "#7A7A7A",
        "default": "#555"
      };

      // ========== UIå‚ç…§ ==========
      const $when = document.getElementById('when');
      const $cat  = document.getElementById('cat');
      const $kw   = document.getElementById('kw');
      const $loc  = document.getElementById('locateBtn');
      const $clr  = document.getElementById('clearRouteBtn');
      const $share= document.getElementById('shareBtn');

      // ========== ç¾åœ¨åœ° ==========
      let userLatLng = null;
      let userMarker = null;
      function getUserLocation() {
        if (!navigator.geolocation) { alert('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLatLng = [pos.coords.latitude, pos.coords.longitude];
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userLatLng, { title: 'ç¾åœ¨åœ°' }).bindPopup('ğŸ“ ç¾åœ¨åœ°').addTo(map);
          },
          err => { alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'); console.warn(err); },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
      $loc.onclick = getUserLocation;

      // ========== ãƒ«ãƒ¼ãƒˆï¼ˆOSRMãƒ‡ãƒ¢ã€‚æ··é›‘æ™‚ã¯å¤±æ•—ã‚ã‚Šï¼‰ ==========
      let routingControl = null;
      function clearRoute() { if (routingControl) { map.removeControl(routingControl); routingControl = null; } }
      function routeTo(lat, lng) {
        if (!userLatLng) { alert('å…ˆã«ï¼»ç¾åœ¨åœ°ã‚’å–å¾—ï¼½ã—ã¦ãã ã•ã„ã€‚'); return; }
        clearRoute();
        routingControl = L.Routing.control({
          waypoints: [ L.latLng(userLatLng[0], userLatLng[1]), L.latLng(lat, lng) ],
          lineOptions: { addWaypoints: false },
          show: false, collapsible: true,
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
          createMarker: () => null
        }).addTo(map);
      }
      $clr.onclick = clearRoute;

      // ========== ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ï¼ˆçµ‚äº†æ¸ˆã¿ã‚’éè¡¨ç¤º / æœªæ¥é †ã«ã‚½ãƒ¼ãƒˆï¼‰ ==========
      let allEvents = [];
      let markers = [];
      const markerById = new Map();
      let openedEventId = null;

      fetch('events.json', { cache:'no-store' })
        .then(r => r.json())
        .then(data => {
          const today = new Date();
          // çµ‚äº†æ—¥ãŒã‚ã‚Œã°çµ‚äº†æ—¥ã€ãªã‘ã‚Œã°é–‹å§‹æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿
          allEvents = data.filter(ev => {
            const end = ev.dateEnd ? new Date(ev.dateEnd) : (ev.dateStart ? new Date(ev.dateStart) : null);
            return end && end >= startOfDay(today);
          });
          allEvents.sort((a,b) => new Date(a.dateStart) - new Date(b.dateStart));
          render();
          // ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å¯¾å¿œï¼ˆ#evt-...ï¼‰
          window.addEventListener('hashchange', openByHash);
          openByHash();
        })
        .catch(err => {
          console.error('events.json ã®èª­è¾¼ã‚¨ãƒ©ãƒ¼:', err);
          document.getElementById('map').insertAdjacentHTML('beforebegin',
            '<div style="padding:10px;color:#b00020;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>');
        });

      // ========== æç”» ==========
      function render() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const now = new Date();
        const range = $when.value;
        const kw = ($kw.value || '').trim().toLowerCase();
        const cat = $cat.value;

        const sod = startOfDay(now), eod = endOfDay(now);
        const endOfW = addDays(sod, 7);
        const endOfM = endOfMonth(now);

        const filtered = allEvents.filter(ev => {
          const s = ev.dateStart ? new Date(ev.dateStart) : null;
          const e = ev.dateEnd ? new Date(ev.dateEnd) : s;
          if (!s) return false;

          // æœŸé–“
          let inRange = true;
          if (range === 'today') inRange = (e >= sod && s < eod);
          if (range === 'week')  inRange = (e >= sod && s < endOfW);
          if (range === 'month') inRange = (e >= sod && s <= endOfM);
          if (!inRange) return false;

          // ã‚«ãƒ†ã‚´ãƒª
          if (cat !== 'all' && (ev.category || '') !== cat) return false;

          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
          if (kw) {
            const hay = `${ev.title||''} ${ev.venue||''} ${ev.address||''} ${ev.description||''}`.toLowerCase();
            if (!hay.includes(kw)) return false;
          }
          return true;
        });

        // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
        markers.forEach(m => map.removeLayer(m));
        markers = []; markerById.clear();

        // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        filtered.forEach(ev => {
          if (!isFinite(ev.lat) || !isFinite(ev.lng)) return;
          const color = CATEGORY_COLORS[ev.category] || CATEGORY_COLORS.default;
          const marker = L.circleMarker([ev.lat, ev.lng], {
            radius: 9, color: color, fillColor: color, fillOpacity: 0.95
          }).addTo(map);

          const s = ev.dateStart ? new Date(ev.dateStart) : null;
          const e = ev.dateEnd ? new Date(ev.dateEnd) : null;
          const dateText = s ? (e ? `${fmtDate(s)}ã€œ${fmtDate(e)}` : `${fmtDateTime(s)}`) : 'æ—¥æ™‚æœªå®š';

          const gmapsLink = `https://www.google.com/maps/dir/?api=1&destination=${ev.lat},${ev.lng}`;
          const popupHtml = `
            <div>
              <div class="popup-title">${escapeHtml(ev.title || '')}</div>
              <div class="badge">${escapeHtml(ev.category || 'ã‚¤ãƒ™ãƒ³ãƒˆ')}</div>
              <div style="margin-top:6px;">ğŸ—“ ${dateText}</div>
              <div>ğŸ“ ${escapeHtml(ev.venue || ev.address || '')}</div>
              ${ev.url ? `<div style="margin-top:6px;"><a class="btn link" href="${ev.url}" target="_blank" rel="noopener">å…¬å¼æƒ…å ±ã‚’é–‹ã</a></div>` : ''}
              ${ev.description ? `<div class="popup-desc">ğŸ“ ${escapeHtml(ev.description)}</div>` : ''}
              <div class="popup-actions">
                <button class="btn run"   id="go-${ev.id}">ã“ã“ã¸è¡Œãï¼ˆç¾åœ¨åœ°â†’ãƒ«ãƒ¼ãƒˆï¼‰</button>
                <a class="btn link" href="${gmapsLink}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§é–‹ã</a>
                <button class="btn link" id="share-${ev.id}">å…±æœ‰</button>
              </div>
            </div>
          `;
          marker.bindPopup(popupHtml);
          marker.on('popupopen', () => {
            const btnGo = document.getElementById(`go-${ev.id}`);
            if (btnGo) btnGo.onclick = () => routeTo(ev.lat, ev.lng);
            const btnShare = document.getElementById(`share-${ev.id}`);
            if (btnShare) btnShare.onclick = () => shareEvent(ev.id);
            // URLãƒãƒƒã‚·ãƒ¥ã‚’åæ˜ ï¼†ä¸€æ™‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            openedEventId = ev.id;
            history.replaceState(null, '', `#${ev.id}`);
            pulse(marker);
          });

          markerById.set(ev.id, marker);
          markers.push(marker);
        });

        // å‡¡ä¾‹ï¼ˆä½¿ç”¨ä¸­ã‚«ãƒ†ã‚´ãƒªã®ã¿è‡ªå‹•ç”Ÿæˆï¼‰
        const legendCats = [...new Set(filtered.map(ev => ev.category || 'ãã®ä»–'))];
        const legendEl = document.getElementById('legend');
        legendEl.innerHTML =
          '<div style="font-weight:600;margin-bottom:4px;">ã‚¸ãƒ£ãƒ³ãƒ«</div>' +
          legendCats.map(c => (
            `<div class="legend-item"><span class="dot" style="background:${CATEGORY_COLORS[c] || CATEGORY_COLORS.default}"></span>${escapeHtml(c)}</div>`
          )).join('');
      }

      // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§å†æç”»
      [$when, $cat, $kw].forEach(el => el.addEventListener('input', render));

      // ========== ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ï¼ˆ#evt-...ï¼‰ ==========
      function openByHash() {
        const id = decodeURIComponent(location.hash.replace('#',''));
        if (id && markerById.has(id)) {
          const m = markerById.get(id);
          m.openPopup();
          map.setView(m.getLatLng(), 14, { animate: true });
          pulse(m);
        }
      }

      // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚‚ã®ã‚’å…±æœ‰
      $share.onclick = () => {
        const id = openedEventId || location.hash.replace('#','');
        if (!id) { alert('å…±æœ‰ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…ˆã«é–‹ã„ã¦ãã ã•ã„ã€‚'); return; }
        shareEvent(id);
      };

      async function shareEvent(id) {
        const url = `${location.origin}${location.pathname}#${encodeURIComponent(id)}`;
        try {
          if (navigator.share) {
            await navigator.share({ title: 'æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP', url });
          } else {
            await navigator.clipboard.writeText(url);
            alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š\n' + url);
          }
        } catch (e) {
          console.warn(e);
          prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š', url);
        }
      }

      // ========== å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
      function pulse(marker) {
        const orig = marker.options.radius;
        marker.setStyle({ radius: orig + 4 });
        setTimeout(() => marker.setStyle({ radius: orig }), 1600);
      }
      function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
      function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+1); }
      function addDays(d,n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
      function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59); }
      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, s => (
          {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
        ));
      }
      function pad(n){ return n<10 ? '0'+n : n; }
      function fmtDate(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
      function fmtDateTime(d){ return `${fmtDate(d)} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    }
  </script>
</body>
</html>
