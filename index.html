<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; font-family: system-ui, -apple-system, "Segoe UI", Roboto; }
    header {
      min-height: 50px;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 16px; }
    #map { flex: 1; width: 100%; }

    /* ã¡ã„ã•ãªå‡¡ä¾‹ */
    .legend {
      position: absolute; z-index: 1000; left: 10px; bottom: 10px;
      background: rgba(255,255,255,.9); border: 1px solid #ddd; border-radius: 6px;
      padding: 6px 8px; font-size: 12px; line-height: 1.4;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .popup-title{ font-weight:700; margin:0 0 4px; font-size:14px; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; background:#eef; }
    .popup-desc{ margin-top:6px; font-size:13px; line-height:1.5; }
  </style>
</head>
<body>
  <header>
    <h1>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</h1>
    <span style="font-size:12px;color:#666;">ï¼ˆOSMæ¨™æº–ï¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ”ãƒ³è¡¨ç¤ºï¼‰</span>
  </header>

  <div id="map"></div>

  <!-- ã‚«ãƒ†ã‚´ãƒªå‡¡ä¾‹ï¼ˆå¿…è¦ãªã‘ã‚Œã°å‰Šé™¤OKï¼‰ -->
  <div class="legend" id="legend"></div>

  <script>
    if (!window.L) {
      document.getElementById('map').innerHTML = 'LeafletãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚';
    } else {
      // æœ­å¹Œä¸­å¿ƒ
      const map = L.map('map').setView([43.0618, 141.3545], 12);

      // OSMæ¨™æº–ã‚¿ã‚¤ãƒ«
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²ï¼ˆå¢—ã‚„ã—ãŸã„å ´åˆã¯ã“ã“ã«è¿½è¨˜ï¼‰
      const CATEGORY_COLORS = {
        "ã‚°ãƒ«ãƒ¡": "#f25f5c",
        "éŸ³æ¥½": "#3a86ff",
        "ã‚¢ãƒ¼ãƒˆ": "#8338ec",
        "ã‚¹ãƒãƒ¼ãƒ„": "#43aa8b",
        "default": "#555"
      };

      // å‡¡ä¾‹ã‚’æç”»
      const legendEl = document.getElementById('legend');
      const legendCats = ["ã‚°ãƒ«ãƒ¡","éŸ³æ¥½","ã‚¢ãƒ¼ãƒˆ","ã‚¹ãƒãƒ¼ãƒ„"];
      legendEl.innerHTML =
        '<div style="font-weight:600;margin-bottom:4px;">ã‚¸ãƒ£ãƒ³ãƒ«</div>' +
        legendCats.map(c => (
          `<div class="legend-item"><span class="dot" style="background:${CATEGORY_COLORS[c]}"></span>${c}</div>`
        )).join('');

      // events.json ã‚’èª­ã¿è¾¼ã‚“ã§ä¸¸ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
      fetch('events.json')
        .then(r => r.json())
        .then(data => {
          data.forEach(ev => {
            if (!isFinite(ev.lat) || !isFinite(ev.lng)) return; // lat/lngãŒç„¡ã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            const color = CATEGORY_COLORS[ev.category] || CATEGORY_COLORS.default;

            const marker = L.circleMarker([ev.lat, ev.lng], {
              radius: 8,
              color: color,
              fillColor: color,
              fillOpacity: 0.9
            }).addTo(map);

            const start = ev.dateStart ? new Date(ev.dateStart) : null;
            const end   = ev.dateEnd ? new Date(ev.dateEnd) : null;
            const dateText = start
              ? (end ? `${fmtDate(start)}ã€œ${fmtDate(end)}` : `${fmtDateTime(start)}`)
              : 'æ—¥æ™‚æœªå®š';

            const popupHtml = `
              <div>
                <div class="popup-title">${escapeHtml(ev.title || '')}</div>
                <div class="badge">${escapeHtml(ev.category || 'ã‚¤ãƒ™ãƒ³ãƒˆ')}</div>
                <div style="margin-top:6px;">ğŸ—“ ${dateText}</div>
                <div>ğŸ“ ${escapeHtml(ev.venue || ev.address || '')}</div>
                ${ev.url ? `<div style="margin-top:6px;"><a href="${ev.url}" target="_blank" rel="noopener">å…¬å¼æƒ…å ±ã‚’é–‹ã</a></div>` : ''}
                ${ev.description ? `<div class="popup-desc">ğŸ“ ${escapeHtml(ev.description)}</div>` : ''}
              </div>
            `;
            marker.bindPopup(popupHtml);
          });
        })
        .catch(err => {
          console.error('events.json ã®èª­è¾¼ã‚¨ãƒ©ãƒ¼:', err);
          alert('events.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        });

      // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, s => (
          {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
        ));
      }
      function pad(n){ return n < 10 ? '0'+n : n; }
      function fmtDate(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
      function fmtDateTime(d){ return `${fmtDate(d)} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    }
  </script>
</body>
</html>
