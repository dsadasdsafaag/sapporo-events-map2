<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4rVYXm5QH6H5K0YlR0NQ0r8r6VY5eGd4v3A3Z8a5r0="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-7QW8g6Dqv1+8u6Xo1mEw4u3G2E7D7d6e2e4tS4lB8fI="
    crossorigin=""
  ></script>

  <!-- Leaflet Routing Machine (ãƒ«ãƒ¼ãƒˆæ¡ˆå†…) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
  />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    :root { --header-h: 64px; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto; }
    header{
      height: var(--header-h);
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    h1 { font-size:16px; margin:0 8px 0 0; }
    #map { height: calc(100vh - var(--header-h)); }
    select, input { padding:8px; font-size:14px; }
    .badge { padding:2px 6px; border-radius:999px; font-size:12px; background:#eef; }
    .popup-title{ font-weight:700; margin:0 0 4px; font-size:14px; }
    .popup-desc{ margin:6px 0 0; line-height:1.5; font-size:13px;}
    .route-tip{ font-size:12px; color:#666; margin-left:auto; }
  </style>
</head>
<body>
  <header>
    <h1>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</h1>
    <select id="when">
      <option value="all">ã„ã¤ã§ã‚‚</option>
      <option value="today">ä»Šæ—¥</option>
      <option value="week">ä»Šé€±</option>
      <option value="month">ä»Šæœˆ</option>
    </select>
    <select id="cat">
      <option value="all">ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆã™ã¹ã¦ï¼‰</option>
      <option value="ã‚°ãƒ«ãƒ¡">ã‚°ãƒ«ãƒ¡</option>
      <option value="éŸ³æ¥½">éŸ³æ¥½</option>
      <option value="ã‚¢ãƒ¼ãƒˆ">ã‚¢ãƒ¼ãƒˆ</option>
      <option value="ã‚¹ãƒãƒ¼ãƒ„">ã‚¹ãƒãƒ¼ãƒ„</option>
    </select>
    <input id="kw" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šå¤§é€šã€å…¬åœ’ã€èŠ±ï¼‰" />
    <div class="route-tip">ç¾åœ¨åœ°â†’ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒˆã¯ã€ãƒ”ãƒ³ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€Œã“ã“ã¸è¡Œãã€ã‹ã‚‰è¡¨ç¤ºã§ãã¾ã™ã€‚</div>
  </header>

  <div id="map"></div>

  <script>
    // ====== è¨­å®šï¼šã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´OKï¼‰======
    const CATEGORY_COLORS = {
      "ã‚°ãƒ«ãƒ¡": "#f25f5c",
      "éŸ³æ¥½": "#3a86ff",
      "ã‚¢ãƒ¼ãƒˆ": "#8338ec",
      "ã‚¹ãƒãƒ¼ãƒ„": "#43aa8b",
      "default": "#555"
    };

    // ====== åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæœ­å¹Œä¸­å¿ƒï¼‰======
    const map = L.map('map').setView([43.0618, 141.3545], 12);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // ====== ç¾åœ¨åœ°ã®è¡¨ç¤º ======
    let userMarker = null;
    let userLatLng = null;

    function showUserLocation() {
      if (!navigator.geolocation) {
        console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLatLng = [pos.coords.latitude, pos.coords.longitude];
          if (userMarker) map.removeLayer(userMarker);
          userMarker = L.marker(userLatLng, { title: "ç¾åœ¨åœ°" })
            .bindPopup("ğŸ“ ç¾åœ¨åœ°")
            .addTo(map);
        },
        err => {
          console.warn('ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ / å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', err);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    showUserLocation();

    // ====== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆç¾åœ¨åœ° â†’ ã‚¤ãƒ™ãƒ³ãƒˆï¼‰======
    let routingControl = null;
    function routeToEvent(evLatLng) {
      if (!userLatLng) {
        alert("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(userLatLng[0], userLatLng[1]),
          L.latLng(evLatLng[0], evLatLng[1])
        ],
        lineOptions: { addWaypoints: false },
        show: false,           // ãƒ‘ãƒãƒ«éè¡¨ç¤ºï¼ˆåœ°å›³ä¸Šã«ç·šã¨çµŒè·¯æƒ…å ±ã®ã¿ï¼‰
        collapsible: true,
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1' // ãƒ‡ãƒ¢ç”¨
        }),
        createMarker: () => null // ãƒ«ãƒ¼ãƒˆä¸Šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆã™
      }).addTo(map);
    }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ & ãƒ”ãƒ³è¡¨ç¤º ======
    let allEvents = [];
    let markers = [];

    fetch('events.json')
      .then(r => r.json())
      .then(data => {
        allEvents = data;
        renderMarkers(allEvents);
      });

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function colorForCategory(cat) {
      return CATEGORY_COLORS[cat] || CATEGORY_COLORS.default;
    }

    function renderMarkers(list) {
      clearMarkers();
      list.forEach(ev => {
        if (!ev.lat || !ev.lng) return;
        const color = colorForCategory(ev.category);
        const marker = L.circleMarker([ev.lat, ev.lng], {
          radius: 8,
          color: color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map);

        const start = ev.dateStart ? new Date(ev.dateStart) : null;
        const end = ev.dateEnd ? new Date(ev.dateEnd) : null;
        const dateText = start
          ? (end ? `${fmtDate(start)}ã€œ${fmtDate(end)}` : `${fmtDateTime(start)}`)
          : 'æ—¥æ™‚æœªå®š';

        const popupHtml = `
          <div>
            <div class="popup-title">${escapeHtml(ev.title || '')}</div>
            <div class="badge">${escapeHtml(ev.category || 'ã‚¤ãƒ™ãƒ³ãƒˆ')}</div>
            <div style="margin-top:6px;">ğŸ—“ ${dateText}</div>
            <div>ğŸ“ ${escapeHtml(ev.venue || ev.address || '')}</div>
            ${ev.url ? `<div style="margin-top:6px;"><a href="${ev.url}" target="_blank" rel="noopener">å…¬å¼æƒ…å ±ã‚’é–‹ã</a></div>` : ''}
            ${ev.description ? `<div class="popup-desc">ğŸ“ ${escapeHtml(ev.description)}</div>` : ''}
            <div style="margin-top:8px;">
              <button id="go-${ev.id}" style="padding:6px 10px; font-size:13px;">ã“ã“ã¸è¡Œãï¼ˆç¾åœ¨åœ°ã‹ã‚‰ãƒ«ãƒ¼ãƒˆï¼‰</button>
            </div>
          </div>
        `;
        marker.bindPopup(popupHtml);
        marker.on('popupopen', () => {
          const btn = document.getElementById(`go-${ev.id}`);
          if (btn) btn.onclick = () => routeToEvent([ev.lat, ev.lng]);
        });

        markers.push(marker);
      });
    }

    // ====== ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ ======
    const $when = document.getElementById('when');
    const $cat  = document.getElementById('cat');
    const $kw   = document.getElementById('kw');
    [$when, $cat, $kw].forEach(el => el.addEventListener('input', applyFilters));

    function applyFilters() {
      const now = new Date();
      const kw = $kw.value.trim().toLowerCase();
      const range = $when.value;
      const cat = $cat.value;

      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
      const endOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate()+7);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth()+1, 0);

      const filtered = allEvents.filter(ev => {
        const s = ev.dateStart ? new Date(ev.dateStart) : null;
        const e = ev.dateEnd ? new Date(ev.dateEnd) : s;
        if (!s) return false;

        // æœŸé–“
        let inRange = true;
        if (range === 'today') inRange = (e >= startOfDay && s < endOfDay);
        if (range === 'week')  inRange = (e >= startOfDay && s < endOfWeek);
        if (range === 'month') inRange = (e >= startOfDay && s <= endOfMonth);
        if (!inRange) return false;

        // ã‚«ãƒ†ã‚´ãƒª
        if (cat !== 'all' && (ev.category || '') !== cat) return false;

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        if (kw) {
          const hay = `${ev.title||''} ${ev.venue||''} ${ev.address||''} ${ev.description||''}`.toLowerCase();
          if (!hay.includes(kw)) return false;
        }
        return true;
      });

      renderMarkers(filtered);
    }

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
      ));
    }
    function pad(n){ return n < 10 ? '0'+n : n; }
    function fmtDate(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
    function fmtDateTime(d){ return `${fmtDate(d)} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  </script>
</body>
</html>
