<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆLeaflet Routing Machine + OSRMï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; font-family: system-ui, -apple-system, "Segoe UI", Roboto; }
    header {
      min-height: 50px;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 16px; }
    #map { flex: 1; width: 100%; }

    /* ã¡ã„ã•ãªå‡¡ä¾‹ */
    .legend {
      position: absolute; z-index: 1000; left: 10px; bottom: 10px;
      background: rgba(255,255,255,.9); border: 1px solid #ddd; border-radius: 6px;
      padding: 6px 8px; font-size: 12px; line-height: 1.4;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .popup-title{ font-weight:700; margin:0 0 4px; font-size:14px; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; background:#eef; }
    .popup-desc{ margin-top:6px; font-size:13px; line-height:1.5; }
    .hint { font-size:12px; color:#666; margin-left:auto; }
    button.small { padding:6px 10px; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>æœ­å¹Œã‚¤ãƒ™ãƒ³ãƒˆMAP</h1>
    <button id="locateBtn" class="small">ç¾åœ¨åœ°ã‚’å–å¾—</button>
    <button id="clearRouteBtn" class="small">ãƒ«ãƒ¼ãƒˆã‚’æ¶ˆã™</button>
    <span class="hint">ãƒ”ãƒ³ã‚’é–‹ã„ã¦ï¼»ã“ã“ã¸è¡Œãï¼½ã§ç¾åœ¨åœ°â†’ã‚¤ãƒ™ãƒ³ãƒˆã®çµŒè·¯ã‚’è¡¨ç¤º</span>
  </header>

  <div id="map"></div>
  <div class="legend" id="legend"></div>

  <script>
    if (!window.L) {
      document.getElementById('map').innerHTML = 'LeafletãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚';
    } else {
      // ===== åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæœ­å¹Œä¸­å¿ƒï¼‰ =====
      const map = L.map('map').setView([43.0618, 141.3545], 12);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // ===== ç¾åœ¨åœ° =====
      let userLatLng = null;
      let userMarker = null;
      function getUserLocation() {
        if (!navigator.geolocation) {
          alert('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLatLng = [pos.coords.latitude, pos.coords.longitude];
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userLatLng, { title: 'ç¾åœ¨åœ°' })
              .bindPopup('ğŸ“ ç¾åœ¨åœ°')
              .addTo(map);
          },
          err => {
            alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            console.warn(err);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
      document.getElementById('locateBtn').onclick = getUserLocation;
      // åˆå›è‡ªå‹•ï¼ˆä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
      getUserLocation();

      // ===== ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆLeaflet Routing Machine + OSRMãƒ‡ãƒ¢ï¼‰ =====
      let routingControl = null;
      function routeTo(lat, lng) {
        if (!userLatLng) {
          alert('å…ˆã«ï¼»ç¾åœ¨åœ°ã‚’å–å¾—ï¼½ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLatLng[0], userLatLng[1]),
            L.latLng(lat, lng)
          ],
          lineOptions: { addWaypoints: false },
          show: false,
          collapsible: true,
          router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
          }),
          createMarker: () => null
        }).addTo(map);
      }
      document.getElementById('clearRouteBtn').onclick = () => {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
      };

      // ===== ã‚«ãƒ†ã‚´ãƒªè‰²ï¼ˆå­¦ã³ãƒ»ãã®ä»–ã‚’è¿½åŠ ï¼‰ =====
      const CATEGORY_COLORS = {
        "ã‚°ãƒ«ãƒ¡":  "#f25f5c",
        "éŸ³æ¥½":   "#3a86ff",
        "ã‚¢ãƒ¼ãƒˆ": "#8338ec",
        "ã‚¹ãƒãƒ¼ãƒ„":"#43aa8b",
        "å­¦ã³":   "#ffbe0b",  // ä¾‹ï¼šã‚»ãƒŸãƒŠãƒ¼/è¬›åº§/ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—
        "ãã®ä»–":  "#6c757d",  // æ±ç”¨ã‚°ãƒ¬ãƒ¼
        "default":"#555"
      };

      // ===== å‡¡ä¾‹ =====
      const legendEl = document.getElementById('legend');
      const legendCats = ["ã‚°ãƒ«ãƒ¡","éŸ³æ¥½","ã‚¢ãƒ¼ãƒˆ","ã‚¹ãƒãƒ¼ãƒ„","å­¦ã³","ãã®ä»–"];
      legendEl.innerHTML =
        '<div style="font-weight:600;margin-bottom:4px;">ã‚¸ãƒ£ãƒ³ãƒ«</div>' +
        legendCats.map(c => (
          `<div class="legend-item"><span class="dot" style="background:${CATEGORY_COLORS[c]}"></span>${c}</div>`
        )).join('');

      // ===== ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º =====
      fetch('events.json', { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
          data.forEach(ev => {
            if (!isFinite(ev.lat) || !isFinite(ev.lng)) return;
            const color = CATEGORY_COLORS[ev.category] || CATEGORY_COLORS.default;

            const marker = L.circleMarker([ev.lat, ev.lng], {
              radius: 8,
              color: color,
              fillColor: color,
              fillOpacity: 0.9
            }).addTo(map);

            const start = ev.dateStart ? new Date(ev.dateStart) : null;
            const end   = ev.dateEnd ? new Date(ev.dateEnd) : null;
            const dateText = start
              ? (end ? `${fmtDate(start)}ã€œ${fmtDate(end)}` : `${fmtDateTime(start)}`)
              : 'æ—¥æ™‚æœªå®š';

            const popupHtml = `
              <div>
                <div class="popup-title">${escapeHtml(ev.title || '')}</div>
                <div class="badge">${escapeHtml(ev.category || 'ã‚¤ãƒ™ãƒ³ãƒˆ')}</div>
                <div style="margin-top:6px;">ğŸ—“ ${dateText}</div>
                <div>ğŸ“ ${escapeHtml(ev.venue || ev.address || '')}</div>
                ${ev.url ? `<div style="margin-top:6px;"><a href="${ev.url}" target="_blank" rel="noopener">å…¬å¼æƒ…å ±ã‚’é–‹ã</a></div>` : ''}
                ${ev.description ? `<div class="popup-desc">ğŸ“ ${escapeHtml(ev.description)}</div>` : ''}
                <div style="margin-top:8px;">
                  <button class="small" id="go-${ev.id}">ã“ã“ã¸è¡Œãï¼ˆç¾åœ¨åœ°â†’ãƒ«ãƒ¼ãƒˆï¼‰</button>
                </div>
              </div>
            `;
            marker.bindPopup(popupHtml);
            marker.on('popupopen', () => {
              const btn = document.getElementById(`go-${ev.id}`);
              if (btn) btn.onclick = () => routeTo(ev.lat, ev.lng);
            });
          });
        })
        .catch(err => {
          console.error('events.json ã®èª­è¾¼ã‚¨ãƒ©ãƒ¼:', err);
          alert('events.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        });

      // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, s => (
          {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
        ));
      }
      function pad(n){ return n < 10 ? '0'+n : n; }
      function fmtDate(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`; }
      function fmtDateTime(d){ return `${fmtDate(d)} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    }
  </script>
</body>
</html>
